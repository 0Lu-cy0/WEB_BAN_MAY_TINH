// Hàm xóa trạng thái sao đánh giá (hiển thị sao rỗng)
function CRateOut(e) {
    for (var t = 1; t <= e; t++) {
        $("#rate" + t).attr("class", "fa fa-star-o"); // Đặt class sao rỗng cho các sao từ 1 đến e
    }
}

// Hàm hiển thị trạng thái sao khi di chuột vào (hiển thị sao đầy)
function CRateOver(e) {
    for (var t = 1; t <= e; t++) {
        $("#rate" + t).attr("class", "fa fa-star"); // Đặt class sao đầy cho các sao từ 1 đến e
    }
}

// Hàm xử lý khi click chọn số sao
function CRateClick(e) {
    // Kích hoạt các phần tử giao diện để người dùng có thể nhập nội dung đánh giá
    $(".uploadimgcheck").removeAttr("disabled"); // Bật nút upload hình ảnh
    $(".write_content_fb").removeClass("cursor-disable"); // Bỏ class vô hiệu hóa vùng nhập nội dung
    $("#ConfirmAdd").removeAttr("disabled"); // Bật nút xác nhận
    $("#FBk_Content").removeAttr("disabled"); // Bật textarea nhập nội dung
    $("#dcript_content_fb").css("color", "#666"); // Đổi màu mô tả
    $("#dcript_content_fb").text("Nhập nội dung đánh giá"); // Cập nhật mô tả

    $("#lblRating").val(e); // Lưu số sao được chọn vào input ẩn lblRating

    // Hiển thị sao đầy cho các sao từ 1 đến e, và sao rỗng cho các sao còn lại
    for (var t = 1; t <= e; t++) {
        $("#rate" + t).attr("class", "fa fa-star"); // Sao đầy
    }
    for (t = 1; t <= 5; t++) {
        $("#rate" + t).attr("class", "fa fa-star-o"); // Sao rỗng (có lỗi logic ở đây, sẽ được giải thích bên dưới)
    }
}

// Hàm hiển thị số sao đã chọn khi tải lại trang
function CRateSelected() {
    var e = $("#lblRating").val(); // Lấy số sao từ input ẩn lblRating
    for (var t = 1; t <= e; t++) {
        $("#rate" + t).attr("class", "fa fa-star"); // Hiển thị sao đầy cho các sao từ 1 đến e
    }
}

// Khi document đã sẵn sàng, khởi tạo hệ thống đánh giá và bình luận
$(document).ready(function () {
    var e, t, n, i;

    // Gọi hàm hiển thị số sao đã chọn (truyền tham số mặc định là 5, nhưng không sử dụng đúng)
    CRateSelected(5);

    // Cấu hình Simditor (trình soạn thảo văn bản)
    Simditor.locale = "en-US"; // Đặt ngôn ngữ là tiếng Anh
    i = ["title", "bold", "italic", "underline", "strikethrough", "fontScale", "color", "|", "ol", "ul", "blockquote", "|", "link", "image", "hr", "|", "indent", "outdent", "alignment"]; // Toolbar đầy đủ cho desktop
    n = ["bold", "underline", "strikethrough", "color", "ul", "ol"]; // Toolbar rút gọn cho mobile

    // Kiểm tra nếu thiết bị là mobile thì dùng toolbar rút gọn
    if (mobilecheck()) {
        i = n;
    }

    // Khởi tạo Simditor cho textarea có ID comment__con
    t = new Simditor({
        textarea: $("#comment__con"), // textarea để nhập bình luận
        toolbar: i, // Cấu hình toolbar
        pasteImage: true, // Cho phép dán hình ảnh
        defaultImage: "/Content/Images/favicon.png", // Hình ảnh mặc định
        upload: "?upload" === location.search && { url: "/upload" } // Cấu hình upload hình ảnh (nếu URL có query ?upload)
    });

    // Nếu có phần tử preview, hiển thị nội dung realtime khi người dùng nhập
    e = $("#preview");
    if (e.length > 0) {
        t.on("valuechanged", function (n) {
            return e.html(t.getValue()); // Cập nhật nội dung preview
        });
    }
});

// Xử lý khi click nút gửi bình luận
$("#create_submit_comment").click(function () {
    // Lấy dữ liệu từ form
    const e = $("#comment__con").val(); // Nội dung bình luận
    const t = $("#product_id").val(); // ID sản phẩm
    const n = $("#discount_id").val(); // ID mã giảm giá (nếu có)
    const i = $("#genre_id").val(); // ID thể loại sản phẩm
    const o = $("#lblRating").val(); // Số sao đánh giá

    // Kiểm tra nội dung bình luận
    if ("" == e) { // Nếu nội dung rỗng
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Nhập nội dung bình luận"
        });
        return false;
    }

    if (e.length < 20) { // Nếu nội dung dưới 20 ký tự
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Nội dung bình luận tối thiểu 20 ký tự"
        });
        return false;
    }

    if (e.length > 500) { // Nếu nội dung vượt quá 500 ký tự
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Nội dung bình luận không quá 500 ký tự"
        });
        return false;
    }

    // Gửi dữ liệu bình luận qua AJAX
    $.ajax({
        type: "Post",
        url: "/Products/ProductComment", // Gửi đến action ProductComment
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
            productID: t,
            discountID: n,
            genreID: i,
            rateStar: o,
            commentContent: e
        }),
        dataType: "json",
        success: function (e) {
            if (1 == e) { // Nếu gửi bình luận thành công
                setTimeout(function () {
                    window.location.reload(); // Tải lại trang để hiển thị bình luận mới
                }, 1);
            }
        },
        error: function () { // Nếu lỗi (thường do chưa đăng nhập)
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 1500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "error",
                title: "Chức năng yêu cầu đăng nhập?"
            });
        }
    });
});

// Hàm tạo form trả lời bình luận
var CreateReplyFeedback = function (e, t) {
    var n, i, o, r;

    // Thêm lời chào vào nội dung trả lời
    $("#reply_comment_con_" + e).text('<p style="font-weight:500;">Chào ' + t + ",</p>");

    // Cấu hình Simditor cho form trả lời bình luận
    Simditor.locale = "en-US";
    r = ["title", "bold", "italic", "underline", "strikethrough", "fontScale", "color", "|", "ol", "ul", "blockquote", "|", "link", "image", "hr", "|", "indent", "outdent", "alignment"];
    o = ["bold", "underline", "strikethrough", "color", "ul", "ol"];
    if (mobilecheck()) {
        r = o; // Dùng toolbar rút gọn cho mobile
    }

    i = new Simditor({
        textarea: $("#reply_comment_con_" + e),
        toolbar: r,
        pasteImage: true,
        defaultImage: "/Content/Images/favicon.png",
        upload: "?upload" === location.search && { url: "/upload" }
    });

    // Hiển thị preview nếu có
    n = $("#preview");
    if (n.length > 0) {
        i.on("valuechanged", function (e) {
            return n.html(i.getValue());
        });
    }

    let a = e; // ID bình luận cần trả lời
    $("#submit_reply_comm_" + a).removeAttr("hidden"); // Hiển thị nút gửi trả lời

    // Xử lý khi click nút gửi trả lời
    $("#submit_reply_comm_" + a).click(function () {
        var e = $("#reply_comment_con_" + a).val(); // Lấy nội dung trả lời

        // Kiểm tra nội dung trả lời
        if ("" == e) {
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "warning",
                title: "Vui lòng nhập nội dung bình luận!"
            });
        } else {
            if (e.length < 20) {
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "warning",
                    title: "Nội dung tối thiểu 20 ký tự"
                });
                return false;
            }
            if (e.length > 500) {
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "warning",
                    title: "Nội dung bình luận không quá 500 ký tự"
                });
                return false;
            }

            // Gửi dữ liệu trả lời qua AJAX
            $.ajax({
                type: "POST",
                url: "/Products/ReplyComment", // Gửi đến action ReplyComment
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    id: a,
                    reply_content: e
                }),
                dataType: "json",
                success: function (e) {
                    if (1 != e) {
                        Swal.mixin({
                            toast: true,
                            position: "top",
                            showConfirmButton: false,
                            timer: 1500,
                            didOpen: e => {
                                e.addEventListener("mouseenter", Swal.stopTimer);
                                e.addEventListener("mouseleave", Swal.resumeTimer);
                            }
                        }).fire({
                            icon: "error",
                            title: "Đã có lỗi xảy ra"
                        });
                        return false;
                    }
                    setTimeout(function () {
                        window.location.reload(); // Tải lại trang để hiển thị trả lời mới
                    }, 1);
                },
                error: function () {
                    Swal.mixin({
                        toast: true,
                        position: "top",
                        showConfirmButton: false,
                        timer: 2500,
                        didOpen: e => {
                            e.addEventListener("mouseenter", Swal.stopTimer);
                            e.addEventListener("mouseleave", Swal.resumeTimer);
                        }
                    }).fire({
                        icon: "error",
                        title: "!Lỗi"
                    });
                }
            });
        }
    });
};

// Hàm tạo form trả lời bình luận con (child reply)
var createChildReply = function (e, t, n) {
    var i, o, r, a;

    child_ide = e; // ID bình luận cha
    child_rep = t; // ID trả lời con

    // Thêm tag người dùng vào nội dung trả lời con
    $("#childRepContent_" + child_rep).text('<p style="font-weight:500;">@' + n + "</p>");

    $("#submit_child_reply_comm_" + child_rep).removeAttr("hidden"); // Hiển thị nút gửi trả lời con

    // Cấu hình Simditor cho form trả lời con
    Simditor.locale = "en-US";
    a = ["title", "bold", "italic", "underline", "strikethrough", "fontScale", "color", "|", "ol", "ul", "blockquote", "|", "link", "image", "hr", "|", "indent", "outdent", "alignment"];
    r = ["bold", "underline", "strikethrough", "color", "ul", "ol"];
    if (mobilecheck()) {
        a = r;
    }

    o = new Simditor({
        textarea: $("#childRepContent_" + child_rep),
        toolbar: a,
        pasteImage: true,
        defaultImage: "/Content/Images/favicon.png",
        upload: "?upload" === location.search && { url: "/upload" }
    });

    i = $("#preview");
    if (i.length > 0) {
        o.on("valuechanged", function (e) {
            return i.html(o.getValue());
        });
    }

    // Xử lý khi click nút gửi trả lời con
    $("#submit_child_reply_comm_" + child_rep).click(function () {
        var e = $("#childRepContent_" + child_rep).val(); // Lấy nội dung trả lời con

        if ("" == e) {
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "warning",
                title: "Vui lòng nhập nội dung bình luận!"
            });
        } else {
            if (e.length < 20) {
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "warning",
                    title: "Nội dung bình luận tối thiểu 20 ký tự"
                });
                return false;
            }
            if (e.length > 500) {
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "warning",
                    title: "Nội dung bình luận không quá 500 ký tự"
                });
                return false;
            }

            // Gửi dữ liệu trả lời con qua AJAX
            $.ajax({
                type: "POST",
                url: "/Products/ReplyComment", // Gửi đến action ReplyComment
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify({
                    id: child_ide,
                    reply_content: e
                }),
                dataType: "json",
                success: function (e) {
                    if (1 == e) {
                        setTimeout(function () {
                            window.location.reload(); // Tải lại trang để hiển thị trả lời con mới
                        }, 1);
                    } else {
                        Swal.mixin({
                            toast: true,
                            position: "top",
                            showConfirmButton: false,
                            timer: 1500,
                            didOpen: e => {
                                e.addEventListener("mouseenter", Swal.stopTimer);
                                e.addEventListener("mouseleave", Swal.resumeTimer);
                            }
                        }).fire({
                            icon: "error",
                            title: "Lỗi"
                        });
                    }
                },
                error: function () {
                    Swal.mixin({
                        toast: true,
                        position: "top",
                        showConfirmButton: false,
                        timer: 2500,
                        didOpen: e => {
                            e.addEventListener("mouseenter", Swal.stopTimer);
                            e.addEventListener("mouseleave", Swal.resumeTimer);
                        }
                    }).fire({
                        icon: "danger",
                        title: "Lỗi"
                    });
                }
            });
        }
    });
};