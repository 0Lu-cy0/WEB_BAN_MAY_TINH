// Hàm định dạng số tiền (thêm dấu chấm ngăn cách hàng nghìn)
function reGex() {
    return regex = /(\d)(?=(\d{3})+(?!\d))/g; // Regex để định dạng số (ví dụ: 1000000 -> 1.000.000)
}

// Hàm cập nhật số lượng sản phẩm khi người dùng tương tác với input số lượng
function Update_quan_mouse_ev() {
    var e = $(".qty-input").data("id"); // Lấy product_id từ thuộc tính data-id của input số lượng
    $(".btn-inc").removeClass("no-pointer-events"); // Bỏ class vô hiệu hóa nút tăng số lượng

    var t = $(".qty-input").val(); // Lấy giá trị số lượng từ input
    if ("" != t) { // Nếu số lượng không rỗng
        Cookie.set("product_" + e, t, 30); // Cập nhật số lượng vào cookie với thời hạn 30 ngày
        updateOrderPrice(); // Cập nhật tổng giá trên giao diện
    }
}

// Hàm tính và cập nhật tổng giá trên giao diện
function updateOrderPrice() {
    $(".lblCartCount").text(Cookie.countProduct()); // Cập nhật số lượng sản phẩm trong giỏ hàng (tổng số sản phẩm)

    var e, t = $("input.qty-input"); // Lấy tất cả input số lượng
    var n = 0; // Tổng giá trị đơn hàng (trước phí vận chuyển và giảm giá)

    // Tính tổng giá trị đơn hàng
    t.each(function (e, t) {
        var r = Number($(t).data("price")); // Giá của sản phẩm (data-price)
        var i = Number($(t).val()); // Số lượng của sản phẩm
        n += r * i; // Cộng dồn vào tổng giá
    });

    var r = $("#discount"); // Phần tử hiển thị giá trị giảm giá
    var i = 0; // Giá trị giảm giá

    // Tính tổng tiền cuối cùng (bao gồm phí vận chuyển, sau giảm giá)
    if (null == r.attr("data-price")) { // Nếu không có mã giảm giá
        e = n + 30000; // Tổng tiền = tổng giá + phí vận chuyển (30,000 VNĐ)
    } else if (r.attr("data-price") < n) { // Nếu giá trị giảm giá nhỏ hơn tổng giá
        i = Number(r.attr("data-price")); // Giá trị giảm giá
        e = n + 30000 - i; // Tổng tiền = tổng giá + phí vận chuyển - giảm giá
    } else { // Trường hợp tổng giá nhỏ hơn giá trị giảm giá
        i = Number(r.attr("data-price"));
        e = 30000; // Tổng tiền chỉ còn phí vận chuyển (ít gặp)
    }

    // Định dạng số tiền
    e += ""; // Chuyển số thành chuỗi
    n += "";
    i += "";
    reGex(); // Áp dụng regex để định dạng số

    // Cập nhật giao diện
    $(".totalPrice").text(n.replace(regex, "$1.") + "₫"); // Hiển thị tổng giá (trước phí và giảm giá)
    $(".totalPriceWithFee").text(e.replace(regex, "$1.") + "₫"); // Hiển thị tổng tiền cuối cùng
    $("#discount").text(i.replace(regex, "$1.") + "₫"); // Hiển thị giá trị giảm giá
}

// Gắn sự kiện cho input số lượng (khi thay đổi hoặc di chuột ra/vào)
$(".qty-input").mouseleave(function () {
    Update_quan_mouse_ev(); // Cập nhật số lượng khi chuột rời khỏi input
});

$(".qty-input").mouseover(function () {
    Update_quan_mouse_ev(); // Cập nhật số lượng khi chuột di vào input
});

$(".qty-input").change(function (e) {
    Update_quan_mouse_ev(); // Cập nhật số lượng khi giá trị input thay đổi
});

$(".qty-input").mouseout(function (e) {
    Update_quan_mouse_ev(); // Cập nhật số lượng khi chuột rời khỏi input
});

// Giảm số lượng sản phẩm khi click nút "-"
$(".btn-dec").click(function (e) {
    $(".btn-inc").removeClass("no-pointer-events"); // Bỏ class vô hiệu hóa nút tăng số lượng

    var t = $(e.currentTarget).next(); // Lấy input số lượng (phần tử tiếp theo của nút "-")
    var n = t.data("id"); // Lấy product_id
    var r = t.data("price"); // Lấy giá sản phẩm
    var i = Number(t.val()); // Lấy số lượng hiện tại

    if (i > 1) { // Nếu số lượng lớn hơn 1, giảm đi 1
        i -= 1;
        Cookie.set("product_" + n, i, 30); // Cập nhật số lượng vào cookie
        t.val(i); // Cập nhật giá trị input
        updateOrderPrice(); // Cập nhật tổng giá

        var o = 0;
        o = i * r; // Tính tổng giá cho sản phẩm này
        o += "";
        $("#total3-" + n).text(o.replace(regex, "$1.") + "₫"); // Cập nhật tổng giá cho sản phẩm trên giao diện
    }
});

// Tăng số lượng sản phẩm khi click nút "+"
$(".btn-inc").click(function (e) {
    var t = $(e.currentTarget).prev(); // Lấy input số lượng (phần tử trước của nút "+")
    var n = t.data("quan"); // Lấy số lượng tối đa (tồn kho)
    var r = t.data("id"); // Lấy product_id
    var i = t.data("price"); // Lấy giá sản phẩm
    var o = Number(t.val()); // Lấy số lượng hiện tại

    if (o < 1) { // Nếu số lượng nhỏ hơn 1, đặt mặc định là 1
        o = 1;
        Cookie.set("product_" + r, o, 30); // Cập nhật số lượng vào cookie
        t.val(o); // Cập nhật giá trị input
        updateOrderPrice(); // Cập nhật tổng giá
    } else if (o >= n) { // Nếu số lượng đạt tối đa (hết hàng)
        $(".btn-inc").addClass("no-pointer-events"); // Vô hiệu hóa nút "+"
        Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "error",
            title: "Số lượng đã đạt giới hạn"
        });
    } else { // Tăng số lượng lên 1
        o += 1;
        Cookie.set("product_" + r, o, 10); // Cập nhật số lượng vào cookie (thời hạn 10 ngày)
        t.val(o); // Cập nhật giá trị input
        updateOrderPrice(); // Cập nhật tổng giá
        reGex(); // Định dạng số tiền

        var a = 0;
        a = o * i; // Tính tổng giá cho sản phẩm này
        a += "";
        $("#total3-" + r).text(a.replace(regex, "$1.") + "₫"); // Cập nhật tổng giá cho sản phẩm trên giao diện
    }
});

// Xóa sản phẩm khỏi giỏ hàng
$(".js-delete").click(function (e) {
    // Hiển thị modal xác nhận xóa
    Swal.fire({
        title: "Xác nhận xóa?",
        text: "Xóa sản phẩm khỏi giỏ hàng",
        icon: "warning",
        showCancelButton: true,
        cancelButtonColor: "#d33",
        confirmButtonColor: "#3085d6",
        cancelButtonText: "Hủy",
        confirmButtonText: "Xác nhận!",
        reverseButtons: true
    }).then(t => {
        if (t.isConfirmed) { // Nếu người dùng xác nhận xóa
            var n = $(e.currentTarget).data("id"); // Lấy product_id
            $(e.currentTarget).closest(".item").remove(); // Xóa hàng sản phẩm khỏi giao diện
            Cookie.remove("product_" + n); // Xóa sản phẩm khỏi cookie

            var r = Cookie.countWithPrefix("product"); // Đếm số sản phẩm còn lại trong giỏ hàng
            $("#cartCount").text(r); // Cập nhật số lượng trên giao diện
            $(".lblCartCount").text(0 == r ? "0" : r); // Cập nhật số lượng giỏ hàng
            $("#emty-product").attr("class", 0 == r ? "d-block" : "d-none"); // Hiển thị thông báo "giỏ hàng trống" nếu không còn sản phẩm
            updateOrderPrice(); // Cập nhật tổng giá

            // Hiển thị thông báo xóa thành công
            Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 1500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "success",
                title: "Xóa thành công"
            });
        }
    });
});

// Chuyển hướng đến trang thanh toán khi click nút "Hoàn tất thanh toán"
$(".js-checkout").click(function (e) {
    e.preventDefault(); // Ngăn hành vi mặc định của link

    var t = Cookie.countWithPrefix("product"); // Đếm số sản phẩm trong giỏ hàng
    $.get("/Account/UserLogged", {}, function (n, r, i) { // Gửi request kiểm tra trạng thái đăng nhập
        if (n) { // Nếu người dùng đã đăng nhập
            if (0 == t) { // Nếu giỏ hàng trống
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 1500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "error",
                    title: "Giỏ hàng chưa có sản phẩm!"
                });
            } else {
                location.href = e.currentTarget.href; // Chuyển hướng đến trang thanh toán
            }
        } else { // Nếu chưa đăng nhập
            Swal.fire({
                title: "Yêu cầu đăng nhập?",
                text: "Vui lòng đăng nhập để thực hiện được chức năng này",
                icon: "error",
                showCancelButton: true,
                cancelButtonColor: "#d33",
                confirmButtonColor: "#3085d6",
                cancelButtonText: "Hủy",
                confirmButtonText: "Đăng nhập",
                reverseButtons: true
            }).then(e => {
                if (e.isConfirmed) {
                    location.href = "login"; // Chuyển hướng đến trang đăng nhập
                }
            });
        }
    }, "json");
});

// Áp dụng mã giảm giá khi click nút "Áp dụng"
$(".btn-submitcoupon").click(function (e) {
    var t = $(e.currentTarget).prev().val().trim(); // Lấy mã giảm giá từ input
    if (t.length) { // Nếu mã không rỗng
        $.getJSON("/cart/UseDiscountCode", { code: t }, function (e, t, n) { // Gửi request AJAX đến action UseDiscountCode
            if (e.success) { // Nếu áp dụng mã giảm giá thành công
                $("#discount").attr("data-price", e.discountPrice); // Lưu giá trị giảm giá vào thuộc tính data-price
                $("#discount").attr("class", "text-success"); // Đổi màu hiển thị thành công
                updateOrderPrice(); // Cập nhật tổng giá

                // Hiển thị thông báo thành công
                Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "success",
                    title: "Mã giảm giá đã được áp dụng thành công!"
                });
            } else { // Nếu áp dụng mã thất bại
                Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 2500,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "error",
                    title: "Lỗi! Vui lòng kiểm tra lại"
                });
            }
        });
    }
});