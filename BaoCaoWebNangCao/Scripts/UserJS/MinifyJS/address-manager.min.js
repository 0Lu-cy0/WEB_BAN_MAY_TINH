// Khi document đã sẵn sàng
$(document).ready(function () {
    // Sự kiện thay đổi tỉnh/thành phố trong form chính (Checkout)
    $("#province").change(function () {
        $("#district").removeClass("cursor-disable"); // Bỏ class vô hiệu hóa giao diện
        $("#district").removeAttr("disabled"); // Bật select quận/huyện

        // Gửi request AJAX để lấy danh sách quận/huyện
        $.get("/Account/GetDistrictsList", { province_id: $("#province").val() }, function (e) {
            $("#district").html("<option value>Quận/ Huyện</option>"); // Reset và thêm tùy chọn mặc định
            // Thêm từng quận/huyện vào select
            $.each(e, function (e, t) {
                $("#district").append("<option value='" + t.district_id + "'>" + t.type + " " + t.district_name + "</option>");
            });
        });
    });

    // Sự kiện thay đổi quận/huyện trong form chính (Checkout)
    $("#district").change(function () {
        $("#ward").removeClass("cursor-disable"); // Bỏ class vô hiệu hóa giao diện
        $("#ward").removeAttr("disabled"); // Bật select phường/xã

        // Gửi request AJAX để lấy danh sách phường/xã
        $.get("/Account/GetWardsList", { district_id: $("#district").val() }, function (e) {
            $("#ward").html("<option value>Phường/ Xã</option>"); // Reset và thêm tùy chọn mặc định
            // Thêm từng phường/xã vào select
            $.each(e, function (e, t) {
                $("#ward").append("<option value='" + t.ward_id + "'>" + t.type + " " + t.ward_name + "</option>");
            });
        });
    });
});

// Khai báo biến cho modal thêm địa chỉ
var createmodal = $("#ModalCreate");

// Mở modal thêm địa chỉ khi click nút "Thêm mới địa chỉ"
$("#popupcreateaddress").click(function () {
    $(".nice-select").remove(); // Xóa các select đã được tùy chỉnh bởi thư viện nice-select
    createmodal.modal("show"); // Hiển thị modal thêm địa chỉ
});

// Đóng các modal khi click nút đóng
$("#closemodal").click(function () {
    editModal.modal("hide"); // Đóng modal chỉnh sửa địa chỉ (modal 1)
});

$("#closemodal1").click(function () {
    editModal.modal("hide"); // Đóng modal chỉnh sửa địa chỉ (modal 1)
});

$("#closemodal4").click(function () {
    editModal2.modal("hide"); // Đóng modal chỉnh sửa địa chỉ (modal 2)
});

$("#closemodal5").click(function () {
    editModal2.modal("hide"); // Đóng modal chỉnh sửa địa chỉ (modal 2)
});

$("#closemodal3").click(function () {
    createmodal.modal("hide"); // Đóng modal thêm địa chỉ
});

// Hàm lưu địa chỉ mới
var ide, SaveAddress = function () {
    // Lấy dữ liệu từ form thêm địa chỉ
    var e = $("#address_name").val(); // Họ tên người nhận
    var t = $("#address_phone").val(); // Số điện thoại
    var i = $("#province").val(); // Tỉnh/thành phố
    var n = $("#district").val(); // Quận/huyện
    var o = $("#address_content").val(); // Địa chỉ cụ thể
    var d = $("#ward").val(); // Phường/xã

    // Kiểm tra các trường bắt buộc
    if ("" == e || "" == t || "" == i || "" == n || "" == d || "" == o) {
        Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Nhập thông tin còn thiếu"
        });
        return false;
    }

    // Kiểm tra số điện thoại (phải đúng 10 chữ số)
    if (t.length < 10 || t.length > 10) {
        Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Số điện thoại phải đúng 10 chữ số"
        });
        return false;
    }

    // Kiểm tra độ dài họ tên (tối đa 20 ký tự)
    if (e.length > 20) {
        Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Họ tên không quá 20 ký tự"
        });
        return false;
    }

    // Kiểm tra độ dài địa chỉ cụ thể (tối đa 50 ký tự)
    if (o.length > 50) {
        Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 2500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Địa chỉ cụ thể không quá 50 ký tự"
        });
        return false;
    }

    // Gửi dữ liệu form qua AJAX để lưu địa chỉ
    var r = $("#create_address").serialize();
    $.ajax({
        type: "POST",
        url: "/Account/AddressCreate", // Gửi đến action AddressCreate
        data: r,
        success: function (e) {
            createmodal.modal("hide"); // Đóng modal
            if (1 == e) { // Nếu lưu thành công
                setTimeout(function () {
                    window.location.reload(); // Tải lại trang để cập nhật giao diện
                }, 1);
            } else { // Nếu lưu thất bại
                Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 1000,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "error",
                    title: "Lỗi"
                });
            }
        }
    });
};

// Khi document đã sẵn sàng (phần chỉnh sửa địa chỉ)
$(document).ready(function () {
    // Sự kiện thay đổi tỉnh/thành phố trong modal chỉnh sửa
    $("#province_edit").change(function () {
        $("#district_edit").removeClass("cursor-disable"); // Bỏ class vô hiệu hóa giao diện
        $("#district_edit").removeAttr("disabled"); // Bật select quận/huyện

        // Gửi request AJAX để lấy danh sách quận/huyện
        $.get("/Account/GetDistrictsList", { province_id: $("#province_edit").val() }, function (e) {
            $("#district_edit").html("<option value>Quận/ Huyện</option>"); // Reset và thêm tùy chọn mặc định
            // Thêm từng quận/huyện vào select
            $.each(e, function (e, t) {
                $("#district_edit").append("<option value='" + t.district_id + "'>" + t.type + " " + t.district_name + "</option>");
            });
        });
    });

    // Sự kiện thay đổi quận/huyện trong modal chỉnh sửa
    $("#district_edit").change(function () {
        $("#ward_edit").removeClass("cursor-disable"); // Bỏ class vô hiệu hóa giao diện
        $("#ward_edit").removeAttr("disabled"); // Bật select phường/xã

        // Gửi request AJAX để lấy danh sách phường/xã
        $.get("/Account/GetWardsList", { district_id: $("#district_edit").val() }, function (e) {
            $("#ward_edit").html("<option value>Phường/ Xã</option>"); // Reset và thêm tùy chọn mặc định
            // Thêm từng phường/xã vào select
            $.each(e, function (e, t) {
                $("#ward_edit").append("<option value='" + t.ward_id + "'>" + t.type + " " + t.ward_name + "</option>");
            });
        });
    });
});

// Khai báo biến cho modal chỉnh sửa địa chỉ
var editModal = $("#EditAddress");

// Hàm mở modal chỉnh sửa địa chỉ
var EditAddress = function (e, t, i, n, o, d, r) {
    $(".nice-select").remove(); // Xóa các select đã được tùy chỉnh bởi thư viện nice-select
    ide = e; // Lưu ID địa chỉ để chỉnh sửa
    $("#province_edit").val(n); // Điền tỉnh/thành phố
    $("#address_name_edit").val(t); // Điền họ tên
    $("#district_edit").val(o); // Điền quận/huyện
    $("#ward_edit").val(d); // Điền phường/xã
    $("#address_content_edit").val(r); // Điền địa chỉ cụ thể
    $("#address_phone_edit").val(i); // Điền số điện thoại
    editModal.modal("show"); // Hiển thị modal chỉnh sửa
};

// Xử lý khi click nút "Xác nhận" trong modal chỉnh sửa
$("#confirmeditBtn").click(function () {
    // Lấy dữ liệu từ form chỉnh sửa
    var e = $("#province_edit").val(); // Tỉnh/thành phố
    var t = $("#address_name_edit").val(); // Họ tên
    var i = $("#district_edit").val(); // Quận/huyện
    var n = $("#ward_edit").val(); // Phường/xã
    var o = $("#address_content_edit").val(); // Địa chỉ cụ thể
    var d = $("#address_phone_edit").val(); // Số điện thoại

    // Kiểm tra các trường bắt buộc
    if ("" == e || "" == t || "" == i || "" == n || "" == o || "" == d) {
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 1500,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Hãy nhập đầy đủ thông tin"
        });
        return false;
    }

    // Kiểm tra độ dài địa chỉ cụ thể (tối đa 50 ký tự)
    if (o.length > 50) {
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Địa chỉ cụ thể không quá 50 ký tự"
        });
        $("#confirmeditBtn").attr("disabled"); // Vô hiệu hóa nút xác nhận (lỗi: thiếu "disabled" value)
        return false;
    }

    // Kiểm tra số điện thoại (phải đúng 10 chữ số)
    if (d.length < 10 || d.length > 10) {
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Số điện thoại phải đúng 10 chữ số"
        });
        return false;
    }

    // Kiểm tra độ dài họ tên (tối đa 20 ký tự)
    if (t.length > 20) {
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 2000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "warning",
            title: "Họ tên không quá 20 ký tự"
        });
        return false;
    }

    // Gửi dữ liệu qua AJAX để cập nhật địa chỉ
    $.ajax({
        type: "post",
        url: "/Account/AddressEdit", // Gửi đến action AddressEdit
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
            id: ide,
            username: t,
            province_id: e,
            district_id: i,
            ward_id: n,
            address_content: o,
            phonenumber: d
        }),
        dataType: "json",
        success: function (e) {
            if (1 == e) { // Nếu cập nhật thành công
                editModal.modal("hide"); // Đóng modal
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2000,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "success",
                    title: "Cập nhật thành công"
                });

                // Cập nhật giao diện mà không cần tải lại trang
                var i = $("#province_edit").find(":selected");
                var n = $("#district_edit").find(":selected");
                var r = $("#ward_edit").find(":selected");
                $("#item-user-name_" + ide).text(t); // Cập nhật họ tên
                $("#item-phone-number_" + ide).text(d); // Cập nhật số điện thoại
                $("#item-content_" + ide).text(o + ", " + r.text() + ", " + n.text() + ", " + i.text()); // Cập nhật địa chỉ đầy đủ
                return;
            }

            // Nếu cập nhật thất bại
            editModal.modal("hide");
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "error",
                title: "Lối! không tìm thấy ID"
            });
            return false;
        },
        error: function () {
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "warning",
                title: "Sửa thất bại"
            });
        }
    });
});

// Hàm mở modal đặt địa chỉ mặc định
var defaultID, defaultmodal = $("#defaultModal"), defaultConfirm = function (e) {
    defaultmodal.modal("show"); // Hiển thị modal
    defaultID = e; // Lưu ID địa chỉ
};

// Đóng modal đặt địa chỉ mặc định
$("#cancle-defalt").click(function () {
    defaultmodal.modal("hide");
});

// Xác nhận đặt địa chỉ mặc định
$("#btn-default-submit").click(function () {
    // Gửi request AJAX để đặt địa chỉ mặc định
    $.ajax({
        type: "POST",
        url: "/Account/DefaultAddress", // Gửi đến action DefaultAddress
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({ id: defaultID }),
        dataType: "json",
        success: function (e) {
            if (1 == e) { // Nếu thành công
                Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 2000,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "success",
                    title: "Cập nhật địa chỉ mặc định thành công"
                });
                defaultmodal.modal("hide");
            } else { // Nếu thất bại (địa chỉ đã là mặc định)
                defaultmodal.modal("hide");
                Swal.mixin({
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false,
                    timer: 2000,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "error",
                    title: "Địa chỉ đang là mặc định!"
                });
            }
        },
        error: function () {
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "error",
                title: "!Lỗi"
            });
        }
    });
});

// Hàm mở modal xóa địa chỉ
var idde, delmodal = $("#deleteModal"), deleteConfirm = function (e) {
    delmodal.modal("show"); // Hiển thị modal
    idde = e; // Lưu ID địa chỉ
};

// Đóng modal xóa địa chỉ
$("#cancle_delete_address").click(function () {
    delmodal.modal("hide");
});

// Xác nhận xóa địa chỉ
$("#btndelete_address").click(function () {
    delmodal.modal("hide"); // Đóng modal
    // Gửi request AJAX để xóa địa chỉ
    $.ajax({
        type: "POST",
        url: "/Account/AddressDelete", // Gửi đến action AddressDelete
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({ id: idde }),
        dataType: "json",
        success: function (e) {
            if (1 == e) { // Nếu xóa thành công
                $("#item_" + idde).remove(); // Xóa địa chỉ khỏi giao diện
                Swal.mixin({
                    toast: true,
                    position: "top",
                    showConfirmButton: false,
                    timer: 2000,
                    didOpen: e => {
                        e.addEventListener("mouseenter", Swal.stopTimer);
                        e.addEventListener("mouseleave", Swal.resumeTimer);
                    }
                }).fire({
                    icon: "success",
                    title: "Xóa thành công"
                });
            }
        },
        error: function () {
            Swal.mixin({
                toast: true,
                position: "top",
                showConfirmButton: false,
                timer: 2500,
                didOpen: e => {
                    e.addEventListener("mouseenter", Swal.stopTimer);
                    e.addEventListener("mouseleave", Swal.resumeTimer);
                }
            }).fire({
                icon: "error",
                title: "!Lỗi"
            });
        }
    });
});

// Kiểm tra dữ liệu trước khi gửi form đặt hàng
$("#save-order").click(function () {
    // Lấy dữ liệu từ form đặt hàng
    const e = $("#province").val(); // Tỉnh/thành phố
    const t = $("#district").val(); // Quận/huyện
    const i = $("#ward").val(); // Phường/xã
    const n = $("#user-name").val(); // Họ tên
    const o = $("#phone-number").val(); // Số điện thoại
    const d = $("#content").val(); // Địa chỉ cụ thể

    // Kiểm tra các trường bắt buộc
    if ("" == e || "" == t || "" == i || "" == n || "" == o || "" == d) {
        Swal.mixin({
            toast: true,
            position: "top",
            showConfirmButton: false,
            timer: 3000,
            didOpen: e => {
                e.addEventListener("mouseenter", Swal.stopTimer);
                e.addEventListener("mouseleave", Swal.resumeTimer);
            }
        }).fire({
            icon: "error",
            title: "Nhập thông tin còn thiếu"
        });
        return false;
    }

    $("#save-order").attr("type", "submit"); // Thay đổi type của nút để gửi form
});